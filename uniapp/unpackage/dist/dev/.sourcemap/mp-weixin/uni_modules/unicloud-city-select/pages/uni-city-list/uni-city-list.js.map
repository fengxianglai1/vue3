{"version":3,"file":"uni-city-list.js","sources":["uni_modules/unicloud-city-select/pages/uni-city-list/uni-city-list.vue","../../../Users/Administrator/Downloads/plugins/uniapp-cli-vite/uniPage:/dW5pX21vZHVsZXMvdW5pY2xvdWQtY2l0eS1zZWxlY3QvcGFnZXMvdW5pLWNpdHktbGlzdC91bmktY2l0eS1saXN0LnZ1ZQ"],"sourcesContent":["<template>\r\n\t<view class=\"page\" :style=\"popupStyleCom\">\r\n\t\t<view class=\"header\">\r\n\t\t\t<view class=\"search-box\">\r\n\t\t\t\t<view class=\"input-box\">\r\n\t\t\t\t\t<input class=\"input\" v-model=\"searchValue\" placeholder=\"搜索城市\" @blur=\"search\" />\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t\t<view class=\"hot-city\">\r\n\t\t\t\t<view class=\"title\">热门城市</view>\r\n\t\t\t\t<view class=\"hot-city-list\">\r\n\t\t\t\t\t<view class=\"hot-city-item\" v-for=\"(item,index) in hotCity\" :key=\"index\" @click=\"hotCityClick(item.code)\">\r\n\t\t\t\t\t\t{{ item.name }}\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t\t<uni-city-list :options=\"list\" :showSelect=\"false\" @click=\"cityClick\"></uni-city-list>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\tconst db = uniCloud.database();\r\n\tconst _ = db.command;\r\n\tconst $ = _.aggregate;\n\t\n\tvar cache = {};\n\t\n\tconst hotCityCacheKey = \"uni-city-list.hotCity\";\r\n\r\n\timport uniCityList from \"../../components/uni-city-list/uni-city-list\"\r\n\texport default {\r\n\t\tcomponents: {\r\n\t\t\tuniCityList\r\n\t\t},\r\n\t\tonLoad() {\r\n\t\t\tthis.getCloudData();\n\t\t\tlet hotCity = uni.getStorageSync(hotCityCacheKey);\n\t\t\tif (hotCity) {\n\t\t\t\tthis.hotCity = hotCity;\n\t\t\t}\r\n\t\t\tconst eventChannel = this.getOpenerEventChannel();\r\n\t\t\t// 监听data事件，获取上一页面通过eventChannel.emit传送到当前页面的数据\n\t\t\tif (eventChannel.on) {\n\t\t\t\teventChannel.on('data', (data) => {\r\n\t\t\t\t\tthis.hotCity = data.hotCity;\n\t\t\t\t\t// 需要缓存\n\t\t\t\t\tuni.setStorageSync(hotCityCacheKey, data.hotCity);\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tsearchValue: \"\",\r\n\t\t\t\twhere: {},\r\n\t\t\t\tlist: [],\r\n\t\t\t\thotCity: []\r\n\t\t\t}\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\t_select(cityInfo) {\r\n\t\t\t\tconst eventChannel = this.getOpenerEventChannel();\r\n\t\t\t\tif (eventChannel.emit) eventChannel.emit('select', cityInfo);\n\t\t\t\tuni.navigateBack();\n\t\t\t},\r\n\t\t\tsearch() {\n\t\t\t\tif (this.searchValue) {\n\t\t\t\t\t// 只有搜索的时候才可以搜索到县级市（因为县级市太多了，如果一开始就全部显示组件会卡住）\n\t\t\t\t\tthis.where = {\n\t\t\t\t\t\tname: new RegExp(this.searchValue),\n\t\t\t\t\t\ttype: _.in([1,2])\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tthis.where = {};\n\t\t\t\t}\r\n\t\t\t\tthis.getCloudData();\r\n\t\t\t},\n\t\t\tgetWhere(){\n\t\t\t\tlet {\n\t\t\t\t\twhere = {}\n\t\t\t\t} = this;\n\t\t\t\treturn {\n\t\t\t\t\ttype: 1,\n\t\t\t\t\t...where\n\t\t\t\t}\n\t\t\t},\r\n\t\t\t// 获取云端数据\r\n\t\t\tasync getCloudData() {\r\n\t\t\t\tlet where = this.getWhere();\n\t\t\t\tif (cache[JSON.stringify(where)]) {\n\t\t\t\t\tthis.list = cache[JSON.stringify(where)];\n\t\t\t\t}\n\t\t\t\tlet dbRes = await db.collection(\"opendb-city-china\").aggregate()\r\n\t\t\t\t\t.match(where)\r\n\t\t\t\t\t.group({\r\n\t\t\t\t\t\t_id: \"$first_letter\",\r\n\t\t\t\t\t\tdata: $.push(\"$name\"),\r\n\t\t\t\t\t\tvalue: $.push({\r\n\t\t\t\t\t\t\tcode: \"$code\",\r\n\t\t\t\t\t\t\tname: \"$name\",\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.addFields({\r\n\t\t\t\t\t\tletter: \"$_id\",\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.sort({\r\n\t\t\t\t\t\t_id: 1\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.limit(1000)\r\n\t\t\t\t\t.end();\r\n\t\t\t\tlet rows = dbRes.result.data;\n\t\t\t\tif (rows && rows.length === 0 && !this.searchValue.trim()) {\n\t\t\t\t\tuni.showModal({\n\t\t\t\t\t\tcontent: \"请右键 uniCloud/database 目录，点击【初始化云函数库】（如果有出现其他表名，不要打勾，直接点覆盖选中的表）\",\n\t\t\t\t\t\tshowCancel: false\n\t\t\t\t\t});\n\t\t\t\t}\r\n\t\t\t\tthis.list = rows;\n\t\t\t\tcache[JSON.stringify(where)] = rows;\r\n\t\t\t},\r\n\t\t\tcityClick(e) {\r\n\t\t\t\tlet name = e.item.name;\r\n\t\t\t\tlet cityInfo = this.getCityInfo({ name });\r\n\t\t\t\tthis._select(cityInfo);\r\n\t\t\t},\r\n\t\t\thotCityClick(code) {\r\n\t\t\t\tlet cityInfo = this.getCityInfo({ code });\r\n\t\t\t\tthis._select(cityInfo);\r\n\t\t\t},\r\n\t\t\tgetCityInfo(obj = {}) {\r\n\t\t\t\tlet { code, name } = obj;\r\n\t\t\t\tlet list = [];\r\n\t\t\t\tthis.list.map((item, index) => {\r\n\t\t\t\t\tlist = list.concat(item.value);\r\n\t\t\t\t});\r\n\t\t\t\tlet cityInfo = list.find((item) => {\r\n\t\t\t\t\treturn (code && item.code == code) || (name && item.name == name);\r\n\t\t\t\t});\r\n\t\t\t\treturn cityInfo;\r\n\t\t\t},\r\n\t\t},\r\n\t\tcomputed: {\n\t\t\tpopupStyleCom() {\r\n\t\t\t\tlet systemInfo = uni.getSystemInfoSync();\r\n\t\t\t\tlet top = systemInfo.safeAreaInsets.top || 0;\r\n\t\t\t\t//console.log('systemInfo: ', systemInfo)\r\n\t\t\t\treturn `height: ${systemInfo.windowHeight - top}px`;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n\t.page {\r\n\t\tbox-sizing: border-box;\r\n\r\n\t\t.header {\r\n\t\t\theight: 165px;\r\n\t\t\tbackground-color: #f8f8f8;\r\n\r\n\t\t\t.search-box {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tpadding: 10px;\r\n\t\t\t\theight: 30px;\r\n\t\t\t\talign-items: center;\r\n\r\n\t\t\t\t.close-box {}\r\n\r\n\t\t\t\t.input-box {\r\n\t\t\t\t\tflex: 1;\r\n\r\n\t\t\t\t\t.input {\r\n\t\t\t\t\t\tbackground-color: #ffffff;\r\n\t\t\t\t\t\tpadding: 5px 10px;\r\n\t\t\t\t\t\tborder-radius: 10px;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t.hot-city {\r\n\t\t\t\tpadding: 10px;\r\n\t\t\t\tbox-sizing: border-box;\r\n\r\n\t\t\t\t.title {\r\n\t\t\t\t\tfont-weight: bold;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.hot-city-list {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-wrap: wrap;\r\n\t\t\t\t\tbox-sizing: border-box;\r\n\t\t\t\t\tmargin: 0 -5px;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.hot-city-item {\r\n\t\t\t\t\tborder: 1px solid #f8f8f8;\r\n\t\t\t\t\tbackground-color: #ffffff;\r\n\t\t\t\t\twidth: calc(25% - 10px);\r\n\t\t\t\t\theight: 30px;\r\n\t\t\t\t\tmargin: 5px;\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tbox-sizing: border-box;\r\n\t\t\t\t\tjustify-content: center;\r\n\t\t\t\t\talign-items: center;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</style>","import MiniProgramPage from 'C:/vue3github/vue3/uniapp/uni_modules/unicloud-city-select/pages/uni-city-list/uni-city-list.vue'\nwx.createPage(MiniProgramPage)"],"names":["uniCloud","uni"],"mappings":"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"}
{"version":3,"names":["db","common_vendor","er","database","_","command","$","aggregate","cache","hotCityCacheKey","uniCityList","_sfc_main","components","onLoad","_this","getCloudData","hotCity","index","getStorageSync","eventChannel","getOpenerEventChannel","on","data","setStorageSync","searchValue","where","list","methods","_select","cityInfo","emit","navigateBack","search","name","RegExp","type","in","getWhere","_this$where","_objectSpread2","_this2","_asyncToGenerator2","_regeneratorRuntime2","mark","_callee","dbRes","rows","wrap","_callee$","_context","prev","next","JSON","stringify","collection","match","group","_id","push","value","code","addFields","letter","sort","limit","end","sent","result","length","trim","showModal","content","showCancel","stop","cityClick","e","item","getCityInfo","hotCityClick","obj","arguments","undefined","map","concat","find","computed","popupStyleCom","systemInfo","getSystemInfoSync","top","safeAreaInsets","windowHeight","wx","createPage","MiniProgramPage"],"sources":["uni-city-list.vue","dW5pX21vZHVsZXMvdW5pY2xvdWQtY2l0eS1zZWxlY3QvcGFnZXMvdW5pLWNpdHktbGlzdC91bmktY2l0eS1saXN0LnZ1ZQ"],"sourcesContent":["<template>\r\n\t<view class=\"page\" :style=\"popupStyleCom\">\r\n\t\t<view class=\"header\">\r\n\t\t\t<view class=\"search-box\">\r\n\t\t\t\t<view class=\"input-box\">\r\n\t\t\t\t\t<input class=\"input\" v-model=\"searchValue\" placeholder=\"搜索城市\" @blur=\"search\" />\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t\t<view class=\"hot-city\">\r\n\t\t\t\t<view class=\"title\">热门城市</view>\r\n\t\t\t\t<view class=\"hot-city-list\">\r\n\t\t\t\t\t<view class=\"hot-city-item\" v-for=\"(item,index) in hotCity\" :key=\"index\" @click=\"hotCityClick(item.code)\">\r\n\t\t\t\t\t\t{{ item.name }}\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t\t<uni-city-list :options=\"list\" :showSelect=\"false\" @click=\"cityClick\"></uni-city-list>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\tconst db = uniCloud.database();\r\n\tconst _ = db.command;\r\n\tconst $ = _.aggregate;\n\t\n\tvar cache = {};\n\t\n\tconst hotCityCacheKey = \"uni-city-list.hotCity\";\r\n\r\n\timport uniCityList from \"../../components/uni-city-list/uni-city-list\"\r\n\texport default {\r\n\t\tcomponents: {\r\n\t\t\tuniCityList\r\n\t\t},\r\n\t\tonLoad() {\r\n\t\t\tthis.getCloudData();\n\t\t\tlet hotCity = uni.getStorageSync(hotCityCacheKey);\n\t\t\tif (hotCity) {\n\t\t\t\tthis.hotCity = hotCity;\n\t\t\t}\r\n\t\t\tconst eventChannel = this.getOpenerEventChannel();\r\n\t\t\t// 监听data事件，获取上一页面通过eventChannel.emit传送到当前页面的数据\n\t\t\tif (eventChannel.on) {\n\t\t\t\teventChannel.on('data', (data) => {\r\n\t\t\t\t\tthis.hotCity = data.hotCity;\n\t\t\t\t\t// 需要缓存\n\t\t\t\t\tuni.setStorageSync(hotCityCacheKey, data.hotCity);\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tsearchValue: \"\",\r\n\t\t\t\twhere: {},\r\n\t\t\t\tlist: [],\r\n\t\t\t\thotCity: []\r\n\t\t\t}\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\t_select(cityInfo) {\r\n\t\t\t\tconst eventChannel = this.getOpenerEventChannel();\r\n\t\t\t\tif (eventChannel.emit) eventChannel.emit('select', cityInfo);\n\t\t\t\tuni.navigateBack();\n\t\t\t},\r\n\t\t\tsearch() {\n\t\t\t\tif (this.searchValue) {\n\t\t\t\t\t// 只有搜索的时候才可以搜索到县级市（因为县级市太多了，如果一开始就全部显示组件会卡住）\n\t\t\t\t\tthis.where = {\n\t\t\t\t\t\tname: new RegExp(this.searchValue),\n\t\t\t\t\t\ttype: _.in([1,2])\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tthis.where = {};\n\t\t\t\t}\r\n\t\t\t\tthis.getCloudData();\r\n\t\t\t},\n\t\t\tgetWhere(){\n\t\t\t\tlet {\n\t\t\t\t\twhere = {}\n\t\t\t\t} = this;\n\t\t\t\treturn {\n\t\t\t\t\ttype: 1,\n\t\t\t\t\t...where\n\t\t\t\t}\n\t\t\t},\r\n\t\t\t// 获取云端数据\r\n\t\t\tasync getCloudData() {\r\n\t\t\t\tlet where = this.getWhere();\n\t\t\t\tif (cache[JSON.stringify(where)]) {\n\t\t\t\t\tthis.list = cache[JSON.stringify(where)];\n\t\t\t\t}\n\t\t\t\tlet dbRes = await db.collection(\"opendb-city-china\").aggregate()\r\n\t\t\t\t\t.match(where)\r\n\t\t\t\t\t.group({\r\n\t\t\t\t\t\t_id: \"$first_letter\",\r\n\t\t\t\t\t\tdata: $.push(\"$name\"),\r\n\t\t\t\t\t\tvalue: $.push({\r\n\t\t\t\t\t\t\tcode: \"$code\",\r\n\t\t\t\t\t\t\tname: \"$name\",\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.addFields({\r\n\t\t\t\t\t\tletter: \"$_id\",\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.sort({\r\n\t\t\t\t\t\t_id: 1\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.limit(1000)\r\n\t\t\t\t\t.end();\r\n\t\t\t\tlet rows = dbRes.result.data;\n\t\t\t\tif (rows && rows.length === 0 && !this.searchValue.trim()) {\n\t\t\t\t\tuni.showModal({\n\t\t\t\t\t\tcontent: \"请右键 uniCloud/database 目录，点击【初始化云函数库】（如果有出现其他表名，不要打勾，直接点覆盖选中的表）\",\n\t\t\t\t\t\tshowCancel: false\n\t\t\t\t\t});\n\t\t\t\t}\r\n\t\t\t\tthis.list = rows;\n\t\t\t\tcache[JSON.stringify(where)] = rows;\r\n\t\t\t},\r\n\t\t\tcityClick(e) {\r\n\t\t\t\tlet name = e.item.name;\r\n\t\t\t\tlet cityInfo = this.getCityInfo({ name });\r\n\t\t\t\tthis._select(cityInfo);\r\n\t\t\t},\r\n\t\t\thotCityClick(code) {\r\n\t\t\t\tlet cityInfo = this.getCityInfo({ code });\r\n\t\t\t\tthis._select(cityInfo);\r\n\t\t\t},\r\n\t\t\tgetCityInfo(obj = {}) {\r\n\t\t\t\tlet { code, name } = obj;\r\n\t\t\t\tlet list = [];\r\n\t\t\t\tthis.list.map((item, index) => {\r\n\t\t\t\t\tlist = list.concat(item.value);\r\n\t\t\t\t});\r\n\t\t\t\tlet cityInfo = list.find((item) => {\r\n\t\t\t\t\treturn (code && item.code == code) || (name && item.name == name);\r\n\t\t\t\t});\r\n\t\t\t\treturn cityInfo;\r\n\t\t\t},\r\n\t\t},\r\n\t\tcomputed: {\n\t\t\tpopupStyleCom() {\r\n\t\t\t\tlet systemInfo = uni.getSystemInfoSync();\r\n\t\t\t\tlet top = systemInfo.safeAreaInsets.top || 0;\r\n\t\t\t\t//console.log('systemInfo: ', systemInfo)\r\n\t\t\t\treturn `height: ${systemInfo.windowHeight - top}px`;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n\t.page {\r\n\t\tbox-sizing: border-box;\r\n\r\n\t\t.header {\r\n\t\t\theight: 165px;\r\n\t\t\tbackground-color: #f8f8f8;\r\n\r\n\t\t\t.search-box {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tpadding: 10px;\r\n\t\t\t\theight: 30px;\r\n\t\t\t\talign-items: center;\r\n\r\n\t\t\t\t.close-box {}\r\n\r\n\t\t\t\t.input-box {\r\n\t\t\t\t\tflex: 1;\r\n\r\n\t\t\t\t\t.input {\r\n\t\t\t\t\t\tbackground-color: #ffffff;\r\n\t\t\t\t\t\tpadding: 5px 10px;\r\n\t\t\t\t\t\tborder-radius: 10px;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t.hot-city {\r\n\t\t\t\tpadding: 10px;\r\n\t\t\t\tbox-sizing: border-box;\r\n\r\n\t\t\t\t.title {\r\n\t\t\t\t\tfont-weight: bold;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.hot-city-list {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-wrap: wrap;\r\n\t\t\t\t\tbox-sizing: border-box;\r\n\t\t\t\t\tmargin: 0 -5px;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.hot-city-item {\r\n\t\t\t\t\tborder: 1px solid #f8f8f8;\r\n\t\t\t\t\tbackground-color: #ffffff;\r\n\t\t\t\t\twidth: calc(25% - 10px);\r\n\t\t\t\t\theight: 30px;\r\n\t\t\t\t\tmargin: 5px;\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tbox-sizing: border-box;\r\n\t\t\t\t\tjustify-content: center;\r\n\t\t\t\t\talign-items: center;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</style>","import MiniProgramPage from 'C:/vue3github/vue3/uniapp/uni_modules/unicloud-city-select/pages/uni-city-list/uni-city-list.vue'\nwx.createPage(MiniProgramPage)"],"mappings":"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","ignoreList":[]}